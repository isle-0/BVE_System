# 单目相机鸟瞰图(BEV)系统

这个项目实现了一个基于单目相机的鸟瞰图(BEV)系统，可以从不同角度拍摄的图像生成俯视图，并在其中标注检测到的目标（如行人、车辆等）。系统通过多个模块的协同工作，实现了从原始图像到鸟瞰图的完整转换流程。

## 功能特点

- 全景图像拼接：将多张不同角度的图像无缝拼接成全景图
- 单目深度估计：从单张图像中估计场景的深度信息
- 目标检测和跟踪：在全景图中检测和跟踪目标物体
- 鸟瞰图转换：将全景图转换为俯视视角的鸟瞰图
- 目标位置标注：在鸟瞰图中标注检测到的目标位置

## 系统架构

系统由以下核心模块组成：

### 1. 全景图像拼接模块 (panorama.py)
- 使用OpenCV的Stitcher类实现图像拼接
- 自动检测图像之间的重叠区域
- 使用特征点匹配和图像融合算法实现无缝拼接
- 支持多张图像的连续拼接

### 2. 深度估计模块 (depth_estimation.py)
- 基于深度学习模型进行单目深度估计
- 使用预训练的MiDaS模型
- 生成像素级的深度图
- 支持深度图的可视化和后处理

### 3. 目标检测模块 (object_detection.py)
- 使用YOLOv5模型进行目标检测
- 支持多种目标类别的检测（行人、车辆等）
- 实现目标跟踪和ID分配
- 提供检测结果的可视化

### 4. 鸟瞰图转换模块 (bev_transform.py)
- 实现从图像空间到鸟瞰图空间的转换
- 使用相机内参矩阵进行投影变换
- 支持自定义鸟瞰图范围和分辨率
- 处理深度信息和目标位置的重投影

### 5. 可视化模块 (visualization.py)
- 提供多种可视化工具
- 支持深度图、目标检测结果的可视化
- 生成鸟瞰图的可视化效果
- 提供交互式的可视化界面

## 安装

1. 克隆仓库：
```bash
git clone [repository-url]
cd BEV_System
```

2. 安装依赖：
```bash
pip install -r requirements.txt
```

## 使用方法

1. 准备图像数据：
   - 使用单目相机从不同角度拍摄场景
   - 确保图像之间有足够的重叠区域
   - 图像格式支持：JPG、PNG、JPEG

2. 运行系统：
```bash
python main.py --input_dir /path/to/images --output_dir /path/to/output
```

### 命令行参数说明：
- `--input_dir`：输入图像目录（必需）
- `--output_dir`：输出目录（必需）
- `--camera_matrix`：相机内参矩阵文件路径（可选）
- `--camera_height`：相机安装高度，单位：米（默认：1.5）
- `--bev_range`：鸟瞰图范围 [x_min x_max y_min y_max]，单位：米（默认：[-2, 2, 0, 4]）
- `--debug`：启用调试模式（可选）

## 项目结构

```
BEV_System/
├── main.py                    # 主程序入口
├── panorama.py               # 全景图像拼接模块
├── depth_estimation.py       # 深度估计模块
├── object_detection.py       # 目标检测模块
├── bev_transform.py          # 鸟瞰图转换模块
├── visualization.py          # 可视化模块
├── create_default_camera_matrix.py  # 相机参数配置
├── requirements.txt          # 项目依赖
├── output/                   # 输出目录
└── pics/                    # 示例图像目录
```

## 实现细节

### 相机参数配置
- 默认相机内参矩阵：
```
[2827,    0, 2016]
[   0, 2827, 1512]
[   0,    0,    1]
```
- 支持通过文件加载自定义相机参数

### 深度估计
- 使用MiDaS模型进行深度估计
- 支持多种预训练模型选择
- 提供深度图的后处理和优化

### 鸟瞰图转换
- 基于投影几何原理
- 考虑相机高度和安装角度
- 支持自定义转换范围和分辨率

## 注意事项

- 确保相机参数已正确标定
- 图像质量会影响最终效果
- 建议在光线充足的环境下拍摄
- 图像之间需要有足够的重叠区域
- 深度估计的准确性依赖于场景的复杂度和光照条件

## 性能优化

- 使用多线程处理图像拼接
- 支持GPU加速（如果可用）
- 图像预处理优化
- 内存使用优化

## 未来改进

- 支持实时处理
- 添加更多目标类别
- 优化深度估计精度
- 改进鸟瞰图转换算法
- 添加更多可视化选项 